name: Agent Test And Release

on:
  push:
    branches:
      - "issue/**"
  workflow_dispatch:
    inputs:
      branch:
        description: "Issue branch (issue/<number>-slug)"
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: agent-test-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  test-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Resolve branch
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "branch=${{ inputs.branch }}" >> "$GITHUB_OUTPUT"
          else
            echo "branch=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run test and release transition
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/test-and-release.ps1 `
            -Repo "${{ github.repository }}" `
            -Branch "${{ steps.vars.outputs.branch }}" `
            -ProjectRoot "."
